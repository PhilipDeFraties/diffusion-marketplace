<%
  practice ||= @practice
  diffused_practices = practice.diffusion_histories
  vamc_facilities = JSON.parse(File.read("#{Rails.root}/lib/assets/vamc.json"))
%>
<div id="adoptions">
  <% diffused_practices.sort_by(&:facility_name).group_by(&:facility_id).each do |dhg| %>
    <% current_diffusion_status = dhg[1][0].diffusion_history_statuses.find_by(end_time: nil) || dhg[1][0].diffusion_history_statuses.order(id: :desc).first %>
    <% facility = vamc_facilities.find { |f| f['StationNumber'] == dhg[0] } %>

    <h2 class="usa-accordion__heading margin-top-105">
      <button class="usa-accordion__button text-normal adoptions-edit"
              aria-expanded="false"
              aria-controls="diffusion_history_<%= current_diffusion_status.id %>">
              <span class="line-height-sans-505 display-inline-block status-width vertical-align-top">
                <%= current_diffusion_status.status %>
              </span>
        <span class="line-height-sans-505 display-inline-block facility-name-width vertical-align-top">
                <%= facility["OfficialStationName"] %>
              </span>
        <span class="line-height-sans-505 display-inline-block timeline-width vertical-align-top">
                <%= month_year_date_format(current_diffusion_status.start_time) %>
          - <%= current_diffusion_status.end_time.present? ? month_year_date_format(current_diffusion_status.end_time) : 'TBD' %>
              </span>
      </button>
    </h2>
    <div id="diffusion_history_<%= current_diffusion_status.id %>" class="usa-accordion__content usa-prose">

      <%= render partial: 'adoption_form', locals: {adoption: current_diffusion_status} %>

    </div>
  <% end %>
</div>
